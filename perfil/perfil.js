// Configuraci√≥n de la API
const API_BASE = 'http://localhost:3000/api/auth';
let currentToken = null;
let currentUser = null;

// Elementos del DOM
const loadingOverlay = document.getElementById('loadingOverlay');
const notificationsModal = document.getElementById('notificationsModal');

// Inicializar la aplicaci√≥n
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Inicializando perfil del usuario...');
    
    // Verificar autenticaci√≥n
    await checkAuthentication();
    
    // Cargar datos del perfil
    await loadUserProfile();
    
    // Configurar eventos
    setupEventListeners();
    
    // Ocultar loading
    hideLoading();
    
    console.log('‚úÖ Perfil cargado exitosamente');
});

// Verificar autenticaci√≥n
async function checkAuthentication() {
    try {
        // Buscar token en localStorage
        const savedToken = localStorage.getItem('authToken');
        
        if (!savedToken) {
            console.warn('‚ö†Ô∏è No se encontr√≥ token de autenticaci√≥n');
            redirectToLogin();
            return;
        }
        
        currentToken = savedToken;
        console.log('üîë Token encontrado:', currentToken.substring(0, 20) + '...');
        
        // Verificar validez del token
        const isValid = await validateToken(currentToken);
        
        if (!isValid) {
            console.error('‚ùå Token inv√°lido o expirado');
            redirectToLogin();
            return;
        }
        
        console.log('‚úÖ Token v√°lido');
        
    } catch (error) {
        console.error('‚ùå Error verificando autenticaci√≥n:', error);
        redirectToLogin();
    }
}

// Validar token con el servidor
async function validateToken(token) {
    try {
        const response = await fetch(`${API_BASE}/profile`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            currentUser = data.user || data;
            return true;
        }
        
        return false;
    } catch (error) {
        console.error('Error validando token:', error);
        return false;
    }
}

// Cargar perfil del usuario
async function loadUserProfile() {
    try {
        console.log('üìä Cargando datos del perfil...');
        
        // Si ya tenemos datos del usuario de la validaci√≥n, usarlos
        if (currentUser) {
            displayUserInfo(currentUser);
            return;
        }
        
        // Si no, hacer una nueva petici√≥n
        const response = await fetch(`${API_BASE}/profile`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            currentUser = data.user || data;
            displayUserInfo(currentUser);
        } else {
            throw new Error('No se pudieron cargar los datos del perfil');
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando perfil:', error);
        showMessage('Error cargando el perfil del usuario', 'error');
    }
}

// Mostrar informaci√≥n del usuario en la interfaz
function displayUserInfo(user) {
    console.log('üë§ Mostrando informaci√≥n del usuario:', user);
    
    // Actualizar elementos del DOM
    const userEmail = document.getElementById('userEmail');
    const userId = document.getElementById('userId');
    const userInitials = document.getElementById('userInitials');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const tokenDisplay = document.getElementById('tokenDisplay');
    const lastLogin = document.getElementById('lastLogin');
    
    if (userEmail && user.email) {
        userEmail.textContent = user.email;
    }
    
    if (userId && user.id) {
        userId.textContent = user.id;
    }
    
    if (userInitials && user.email) {
        // Generar iniciales del email
        const initials = user.email.substring(0, 2).toUpperCase();
        userInitials.textContent = initials;
    }
    
    if (welcomeMessage && user.email) {
        const userName = user.name || user.email.split('@')[0];
        welcomeMessage.textContent = `${userName}, es genial tenerte de vuelta!`;
    }
    
    if (tokenDisplay && currentToken) {
        tokenDisplay.textContent = currentToken;
    }
    
    if (lastLogin) {
        const now = new Date();
        lastLogin.textContent = now.toLocaleString('es-ES');
    }
}

// Configurar event listeners
function setupEventListeners() {
    // Cerrar modal al hacer clic fuera
    window.addEventListener('click', (event) => {
        if (event.target === notificationsModal) {
            closeNotifications();
        }
    });
    
    // Manejar tecla ESC para cerrar modal
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeNotifications();
        }
    });
}

// Mostrar/ocultar loading
function showLoading() {
    if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
    }
}

function hideLoading() {
    if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
    }
}

// Funciones de navegaci√≥n y acciones
function redirectToLogin() {
    console.log('üîÑ Redirigiendo al login...');
    // Limpiar datos locales
    localStorage.removeItem('authToken');
    currentToken = null;
    currentUser = null;
    
    // Redirigir al login (ajusta la ruta seg√∫n tu estructura)
    window.location.href = 'index.html';
}

// Funci√≥n de logout
function logout() {
    console.log('üö™ Cerrando sesi√≥n...');
    
    // Mostrar confirmaci√≥n
    if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        // Limpiar datos locales
        localStorage.removeItem('authToken');
        currentToken = null;
        currentUser = null;
        
        // Mostrar mensaje
        showMessage('Sesi√≥n cerrada exitosamente', 'success');
        
        // Redirigir despu√©s de un breve delay
        setTimeout(() => {
            redirectToLogin();
        }, 1500);
    }
}

// Funciones de prueba de JWT
async function testProfile() {
    console.log('üß™ Probando perfil con token actual...');
    showLoading();
    
    if (!currentToken) {
        showMessage('No hay token disponible para probar', 'error');
        hideLoading();
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/profile`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (response.ok) {
            showMessage('‚úÖ Token v√°lido - Autenticaci√≥n exitosa', 'success');
            console.log('‚úÖ Perfil obtenido:', data);
        } else {
            showMessage('‚ùå Token inv√°lido o expirado', 'error');
            console.error('‚ùå Error del servidor:', data);
        }
    } catch (error) {
        showMessage('‚ùå Error de conexi√≥n con el servidor', 'error');
        console.error('‚ùå Error de red:', error);
    } finally {
        hideLoading();
    }
}

async function testRefresh() {
    console.log('üîÑ Renovando token...');
    showLoading();
    
    if (!currentToken) {
        showMessage('No hay token disponible para renovar', 'error');
        hideLoading();
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/refresh`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();

        if (response.ok) {
            // Actualizar token
            currentToken = data.token;
            localStorage.setItem('authToken', currentToken);
            
            // Actualizar UI
            const tokenDisplay = document.getElementById('tokenDisplay');
            if (tokenDisplay) {
                tokenDisplay.textContent = currentToken;
            }
            
            console.log('üîë Nuevo token:', currentToken.substring(0, 20) + '...');
            showMessage('üîÑ Token renovado exitosamente', 'success');
        } else {
            showMessage('‚ùå No se pudo renovar el token', 'error');
            console.error('‚ùå Error renovando token:', data);
        }
    } catch (error) {
        showMessage('‚ùå Error de conexi√≥n al renovar token', 'error');
        console.error('‚ùå Error de red:', error);
    } finally {
        hideLoading();
    }
}

async function testInvalidToken() {
    console.log('üß™ Probando con token inv√°lido...');
    showLoading();
    
    const fakeToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkZha2UgVG9rZW4iLCJpYXQiOjE1MTYyMzkwMjJ9.invalid_signature';
    
    try {
        const response = await fetch(`${API_BASE}/profile`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${fakeToken}`,
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();
        
        if (response.ok) {
            showMessage('‚ö†Ô∏è Advertencia: Token inv√°lido fue aceptado', 'warning');
        } else {
            showMessage('‚úÖ Correcto: Token inv√°lido fue rechazado', 'success');
            console.log('‚úÖ El servidor rechaz√≥ correctamente el token inv√°lido');
        }
    } catch (error) {
        showMessage('‚ùå Error de conexi√≥n durante la prueba', 'error');
        console.error('‚ùå Error de red:', error);
    } finally {
        hideLoading();
    }
}

// Funci√≥n para copiar token
function copyToken() {
    if (!currentToken) {
        showMessage('No hay token para copiar', 'error');
        return;
    }
    
    navigator.clipboard.writeText(currentToken).then(() => {
        showMessage('üìã Token copiado al portapapeles', 'success');
        console.log('üìã Token copiado');
    }).catch(() => {
        // Fallback para navegadores que no soportan clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = currentToken;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showMessage('üìã Token copiado al portapapeles', 'success');
    });
}

// Funciones de modal de notificaciones
function toggleNotifications() {
    if (notificationsModal.style.display === 'block') {
        closeNotifications();
    } else {
        openNotifications();
    }
}

function openNotifications() {
    notificationsModal.style.display = 'block';
    console.log('üîî Modal de notificaciones abierto');
}

function closeNotifications() {
    notificationsModal.style.display = 'none';
    console.log('üîî Modal de notificaciones cerrado');
}

// Funciones de navegaci√≥n (placeholders)
function openSettings() {
    showMessage('‚öôÔ∏è Funci√≥n de configuraci√≥n pr√≥ximamente', 'info');
    console.log('‚öôÔ∏è Navegando a configuraci√≥n...');
}

function viewProjects() {
    showMessage('üìÅ Funci√≥n de proyectos pr√≥ximamente', 'info');
    console.log('üìÅ Navegando a proyectos...');
}

function viewReports() {
    showMessage('üìà Funci√≥n de reportes pr√≥ximamente', 'info');
    console.log('üìà Navegando a reportes...');
}

function viewTeam() {
    showMessage('üë• Funci√≥n de equipo pr√≥ximamente', 'info');
    console.log('üë• Navegando a equipo...');
}

// Funci√≥n para mostrar mensajes (mejorada)
function showMessage(message, type = 'info') {
    // Crear elemento de mensaje
    const messageElement = document.createElement('div');
    messageElement.className = `toast-message ${type}`;
    messageElement.innerHTML = message;
    
    // Estilos del toast
    messageElement.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        padding: 15px 20px;
        border-radius: 10px;
        font-weight: 500;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        transform: translateX(400px);
        transition: all 0.3s ease;
        max-width: 350px;
        word-wrap: break-word;
    `;
    
    // Colores seg√∫n el tipo
    switch (type) {
        case 'success':
            messageElement.style.background = '#d4edda';
            messageElement.style.color = '#155724';
            messageElement.style.border = '1px solid #c3e6cb';
            break;
        case 'error':
            messageElement.style.background = '#f8d7da';
            messageElement.style.color = '#721c24';
            messageElement.style.border = '1px solid #f5c6cb';
            break;
        case 'warning':
            messageElement.style.background = '#fff3cd';
            messageElement.style.color = '#856404';
            messageElement.style.border = '1px solid #ffeaa7';
            break;
        case 'info':
        default:
            messageElement.style.background = '#d1ecf1';
            messageElement.style.color = '#0c5460';
            messageElement.style.border = '1px solid #bee5eb';
            break;
    }
    
    // Agregar al DOM
    document.body.appendChild(messageElement);
    
    // Animar entrada
    setTimeout(() => {
        messageElement.style.transform = 'translateX(0)';
    }, 100);
    
    // Remover despu√©s de 4 segundos
    setTimeout(() => {
        messageElement.style.transform = 'translateX(400px)';
        setTimeout(() => {
            if (messageElement.parentNode) {
                messageElement.parentNode.removeChild(messageElement);
            }
        }, 300);
    }, 4000);
    
    console.log(`üí¨ Mensaje mostrado: ${message}`);
}

// Funci√≥n de utilidad para formatear fechas
function formatDate(date) {
    return new Intl.DateTimeFormat('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).format(date);
}

// Funci√≥n para manejar errores globales
window.addEventListener('error', (event) => {
    console.error('‚ùå Error global capturado:', event.error);
    showMessage('Ha ocurrido un error inesperado', 'error');
});

// Funci√≥n para manejar promesas rechazadas
window.addEventListener('unhandledrejection', (event) => {
    console.error('‚ùå Promesa rechazada no manejada:', event.reason);
    showMessage('Error de conexi√≥n o servidor', 'error');
});

// Exportar funciones principales para debugging
window.debugProfile = {
    currentToken: () => currentToken,
    currentUser: () => currentUser,
    testProfile,
    testRefresh,
    testInvalidToken,
    logout
};

console.log('üîß Funciones de debug disponibles en window.debugProfile');